# 期末报告-C4编译器


## 编译器
#### 概念表达
简单讲，编译器就是将“一种语言（通常为高级语言）”翻译为“另一种语言（通常为低级语言）”的程序。

高级计算机语言便于人编写，阅读交流，维护。机器语言是计算机能直接解读、运行的。编译器将汇编或高级计算机语言源程序（Source program）作为输入，翻译成目标语言（Target language）机器代码的等价程序。源代码一般为高级语言 (High-level language)， 如Pascal、C、C++、Java、汉语编程等或汇编语言，而目标则是机器语言的目标代码（Object code），有时也称作机器代码（Machine code）

#### 定义
编译器是指从高级语言到低级语言的翻译器，同样的技术可用于不同种类语言之间的翻译。编译器是一种电脑程式，它会将用某种编程语言写成的源代码（原始语言），转换成另一种编程语言（目标语言）。

它主要的目的是将便于人编写，阅读，维护的高级电脑语言所写作的源代码程式，翻译为电脑能解读、运行的低阶机器语言的程式，也就是可执行文件。编译器将原始程式（Source program）作为输入，翻译产生使用目标语言（Target language）的等价程式。源代码一般为高阶语言 (High-level language), 如 Pascal、C、C++、C# 、Java 等，而目标语言则是彙编语言或目标机器的目标代码（Object code），有时也称作机器代码（Machine code）。


### 编译器分类
典型的编译器输出是由包含人口点的名字和地址以及外部调用的机器代码所组成的目标文件。一组目标文件，不必是同一编译器产生，但使用的编译器必须採用同样的输出格式，可以链接在一起并生成可以由用户直接执行的可执行程式。

在运行过程中，编译器又可分成只依赖于源语言的编译器前端和只依赖于目标语言的编译器后端两大部分，编译器前后端结构如图所示。
  
![image](https://wiki.mbalib.com/w/images/b/b1/%E5%9B%BE%E7%BC%96%E8%AF%91%E5%99%A8%E5%89%8D%E5%90%8E%E7%AB%AF%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg)

前端還負責語義(semantic checking)的檢查，例如檢測參與運算的變數是否是同一類型的，簡單的錯誤處理。最終的結果常常是一個抽象的語法樹AST(Abstract Syntax Tree)，這樣後端可以在此基礎上進一步優化處理。編譯器後端主要負責分析、優化中間代碼以及生成機器代碼。一般來說所有的編譯器分析、優化、變型都可以分成兩大類：函數內進行和函數間進行。很明顯，函數間的分析優化更準確，但需要更長的時間來完成。

一般編譯器可以分為以下兩類：

* “本地”編譯器：編譯器可以生成用來在與編譯器本身所在的電腦和操作系統(平臺)相同的環境下運行的目標代碼。

* 交叉編譯器：編譯器也可以生成用來在其他平臺上運行的目標代碼，交叉編譯器在生成新的硬體平臺時非常有用。

### 编译器工作流程
一个现代编译器的主要工作流程如下：源代码 (source code) → 预处理器 (preprocessor) → 编译器 (compiler) → 彙编程式 (assembler) → 目标代码 (object code) → 链接器 (Linker) → 可执行文件 (executables)


### 工作原理
编译是从源代码（通常为高级语言）到能直接被计算机或虚拟机执行的目标代码（通常为低级语言或机器语言）的翻译过程。然而，也存在从低级语言到高级语言的编译器，这类编译器中用来从由高级语言生成的低级语言代码重新生成高级语言代码的又被叫做反编译器。也有从一种高级语言生成另一种高级语言的编译器，或者生成一种需要进一步处理的的中间代码的编译器（又叫级联）。

典型的编译器输出是由包含入口点的名字和地址， 以及外部调用（到不在这个目标文件中的函数调用）的机器代码所组成的目标文件。一组目标文件，不必是同一编译器产生，但使用的编译器必需采用同样的输出格式，可以链接在一起并生成可以由用户直接执行的EXE,
所以我们电脑上的文件都是经过编译后的文件。


#### 交叉编译器
交叉编译这个概念的出现和流行是和嵌入式系统的广泛发展同步的。在进行嵌入式系统的开发时，运行程式的目标平台通常只有有限的存储空间和运算能力。例如常见的ARM平台，其一般的静态存储空问为16～32MB，而处理器的主频为100～500MHz。这种情况下，在ARM平台上进行本机编译就不太可能了，这是因为一般的编译工具需要很大的存储空间，并需要很强的处理器运算能力。为瞭解决这个问题，交叉编译工具就应运而生了。通过交叉编译工具，就可以在CPU能力很强、存储控制项足够的主机平台上(例如通用电脑)编译出针对其他运行平台的可执行程式。

在交叉編譯技術中有兩種比較典型的實現，一個稱之為Java模式，即Java的位元組碼編譯技術；另一個稱之為GNUGCC模式，即通常所講的CrossGCC技術。Java模式(如圖所示)的最大特點是引入了一個自定義的虛擬機，即Java虛擬機JVM(Java Virtual Machine)。所有Java源程式都會首先被編譯成只在這個虛擬機上才能執行的“目標代碼”：位元組碼(Bytecode)。在實時運行時，可以有兩種運行方式：一種是編譯所獲得的位元組碼由JVM在實際電腦系統上執行；另一種方式是通過Java實時編譯器(Just-In-TimeCompiler)將位元組碼首先轉換成本地機可直接執行的目標代碼，而後交給實際的電腦系統運行。這實際上是一個兩次編譯過程，一次是非實時的，一次是實時的。由於第一次是非實時編譯，Java編譯器生成的是基於JVM的“目標代碼”，可以將它的編譯技術也稱為交叉編譯。



![image](https://wiki.mbalib.com/w/images/d/d2/%E5%9B%BEJava%E6%A8%A1%E5%BC%8F%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91.jpg)
![image](https://wiki.mbalib.com/w/images/2/25/%E5%9B%BEGCC%E6%A8%A1%E5%BC%8F%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91.jpg)

### 编译器的编写分为 3 个步骤
* 词法分析器，用于将字串转化成内部的表示结构。
* 语法分析器，将词法分析得到的标记流生成一棵语法树。
* 目的码的生成，将语法树转化成目的码。
### 编译器的框架
```
next() 用于词法分析，获取下一个标记，它将自动忽略空白字元。
program() 语法分析的入口，分析整个 C 语言程式。
expression(level) 用于解析一个表示式。
eval() 虚拟机器的入口，用于解释目的码。
```
### 编译器主要关注内容
* 程式码段、资料段以及处理函式呼叫相关的资料。
* 因为我们的编译器并不支援初始化变数，因此我们不需要未初始化资料段。
* 理论上我们的虚拟器需要维护自己的堆用于记忆体分配，但实际实现上较为複杂且与编译无关，故我们引入一个指令MSET，使我们能直接使用编译器中的记忆体。
* int型程式码段中存放如指标/记忆体地址的资料，应该作为无符号，char * 型 资料段由于只存放字串。
* 在main函式中加入初始化程式码，为其分配记忆体。

## 暂存器
#### 概念表达
暂存器是用来暂存由数据总线或通用寄存的东西。它是中央处理器内的其中组成部份。 暂存器是有限存贮容量的高速存贮部件，它们可用来暂存指令、 数据和位址 。

#### 结构组成
在中央处理器的控制部件中，包含的暂存器有指令暂存器 （IR）和程式计数器 （PC）。在中央处理器的算术及逻辑部件中，包含的暂存器有累加器 （ACC）。
在电脑架构里，处理器中的暂存器是少量且速度快的电脑记忆体 ，借由提供快速共同地存取数值来加速电脑程式的执行——典型地说就是在已知时间点所作的之计算中间的数值。

* PC 程式计数器，它存放的是一个记忆体地址，该地址中存放著 下一条 要执行的计算机指令。
    * main 函式中加入初始化程式码，注意的是PC在初始应指向目的码中的main函式
* SP 指标暂存器，永远指向当前的栈顶。注意的是由于栈(处理函式呼叫相关的资料)是位于高地址并向低地址增长的，所以入栈时 SP 的值减小。
* BP 基址指标。也是用于指向栈的某些位置，在呼叫函式时会使用到它。
* AX 通用暂存器，我们的虚拟机器中，它用于存放一条指令执行后的结果。

## C4编译器介绍 
* C4 是一个小型 C 语言编译器，它具备完整的词法分析、语法分析、简单的语义检查、代码生成、运行时环境（即虚拟机）。
* 它与常见的C编译器不同的地方在于，它把C语言源程序编译成字节码（bytecode），然后在一个精简的虚拟机中解释执行。
* 
### C4编译器语法 
* [编译器的语法](https://gitlab.com/ccc109/sp/-/blob/master/C1-c4/C4%E7%B7%A8%E8%AD%AF%E5%99%A8%E7%9A%84%E8%AA%9E%E6%B3%95.md)

### C4 code
* [code](https://gitlab.com/ccc109/sp/-/blob/master/C1-c4/c4.c)

### 总结

* c4的代码简洁，但较难懂，好多变量都是缩写。
* 功能齐全，满足编译器开发的，词法分析，语法分析，目标代码生成的三个基本步骤。
* 实现了自举，可以自己编译自己。

## 参考资料
* 上课知识
* 百度百科
* [智库百科](https://www.baidu.com/link?url=2jvltG1iA-UQuDKLhTv-3X-Kk-pO7_1cnXNkolX9HQO1NqXljB0G_H1vDUb87nsR&wd=&eqid=960c7f990008a0d90000000660d857d2)
* [程式入门教学](https://www.itread01.com/content/1546074380.html)

